easyblock = 'PythonPackage'

name = 'SCGid'
version = '0.9b0'
# No tagged commit for SCGid 0.9b, taking commit from commit history
local_commit = 'be106e4cd888fd913a527ea821e510e0afb100be'

homepage = 'https://github.com/amsesk/SCGid'
description = 'A consensus approach to contig filtering and genome prediction from single-cell sequencing libraries'

toolchain = {'name': 'foss', 'version': '2021b'}

source_urls = ["https://github.com/amsesk/SCGid/archive"]
sources = ['%s.tar.gz' % local_commit]
patches = [
    "SCGid-0.9-fixPrintToPython3.patch",
    "SCGid-0.9b0-initEdit.patch"
]
checksums = [
    # be106e4cd888fd913a527ea821e510e0afb100be.tar.gz
    '1f625e8f87b4d5e4ec9831ebe48763676679d6d6c41b05ef0bb59e6a7f839153',
    'ee251b71ed3eed097b05751a3cea302d954000e1a8112e6e3f297e67c84996f7',  # SCGid-0.9-fixPrintToPython3.patch
    '5deb9911beef69bc127b966f94199511800069737f822e15ca5115a16d8b50c5',  # SCGid-0.9b0-initEdit.patch
]

local_clams_commit = "e326c34307803b9ea8ffc975ddd9bd05643af931"

builddependencies = [('Python', '3.9.6')]

dependencies = [
    ('R', '4.1.2'),
    ('BLAST+', '2.12.0'),
    ('AUGUSTUS', '3.4.0'),
    ('Java', '11', '', True),
    ('Maven', '3.6.3', '', True),
    ('plotly.py', '5.4.0'),
    ('ETE', '3.1.2'),
    ('PyYAML', '5.4.1'),
]

use_pip = True
sanity_pip_check = True
download_dep_fail = False

exts_defaultclass = "Tarball"
local_config_path = "%(installdir)s/lib/python3.9/site-packages/config.yaml"
local_config_prep = "%%(installdir)s/SCGid-%s/config.yaml" % local_commit

postinstallcmds = [
    'ln -s %%(installdir)s/ClaMS-CLI-fork-%s/ClaMS-CLI.jar %%(installdir)s/ClaMS-CLI.jar' % local_clams_commit,
    'export PATH=$PATH:$EBROOTAUGUSTUS',
    'export PATH=$PATH:$EBROOTBLAST',
]

options = {'modulename': False}

exts_list = [
    ('ClaMS-CLI', '31012020', {
        'source_tmpl': 'e326c34307803b9ea8ffc975ddd9bd05643af931.tar.gz',
        'source_urls': ['https://github.com/amsesk/ClaMS-CLI-fork/archive'],
        'checksums': ['743397fc8308e363f127bd7e5165ac9d769c10305f6e33d9e408db8f343170db'],
    }),
    ('ESOM', '1.1', {
        'download_instructions': """
            You need to manually provide Databionics ESOM. Please, follow these steps:
            (1): Go to https://sourceforge.net/projects/databionic-esom/files/databionic-esom/1.1/ and
                 download "esom-1.1-installer.jar"
            (2): Run the file and follow through the installation process (ensure you have Java
                 installed to run the file)
            (3): Open terminal in the folder where you have installed ESOM and create Tarball of
                 its contents (tar -czvf esom.tar.gz *)
            (4): Paste the file created (esom.tar.gz) into the same folder where your easyconfig is
            (5): Re-run the build.
            """,
        'source_tmpl': 'esom.tar.gz',
        # Checksum isn't used because user will be providing this extension
        'checksums': [None]
    }),
]

sanity_check_commands = ["scgid --help"]

moduleclass = 'bio'
